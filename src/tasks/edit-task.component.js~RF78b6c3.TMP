controller.$inject = ['$modalService', '$state', 'tasksService'];
function controller($modalService, $state, tasksService){
  var $ctrl = this;
  $ctrl.options = {
    // formState用于各field之间传值
    formState: {
      hideSiteId: false
    }
  };
  $ctrl.fields = [];
  $ctrl.model = {};
  $ctrl.createTask = createTask;
  $ctrl.data = {}; // 编辑任务用
  var rulesOptions = [];

  // 当前是否是创建任务页
  var isNewTask = $state.is('newTask');

  if(isNewTask) {
    $ctrl.model.ruleType = 1;
    $ctrl.fields = [
      {
        key: 'RuleGroupID',
        type: 'select2',
        templateOptions: {
          label: '选择标签规则组',
          valueProp: 'RuleGroupID',
          labelProp: 'RuleGroupName',
          options: [],
          required: true
        },
        controller: ['$scope', 'rulesService', function($scope, rulesService){
          rulesService.getRules({ Status: 4 })
          .then(function(data){
            console.log(data);
            // RuleGroupType
            // 1.如选择的标签规则组类型是呼叫中心或社会化媒体
            // 则隐藏输入site ID/广告ID一项。
            rulesOptions = data && data.Data || [];

            rulesOptions = [{
              "SiteID":"@@@",
              "RuleGroupName":"则组A",
              "RuleGroupType":"网站",
              "CreateTime":"2016-11-22T11:47:43",
              "RuleGroupID":"336fc397-d61a-4cff-be18-cf9c0c33fe7f"
            },{
              "SiteID":"1387",
              "RuleGroupName":"测试规则组final_1387",
              "RuleGroupType":"广告",
              "CreateTime":"2016-11-22T10:23:52",
              "RuleGroupID":"cc410290-d3be-4c31-ab24-1949ca7f0d01"
            },{
              "SiteID":"1385",
              "RuleGroupName":"test",
              "RuleGroupType":"社会化媒体",
              "CreateTime":"2016-11-22T10:22:37",
              "RuleGroupID":"e828ea36-36a6-489c-99dd-58ceff1c4f0b"
            }];


            $scope.to.options = rulesOptions;
            if(rulesOptions.length) {
              $scope.model.RuleGroupID = rulesOptions[0].RuleGroupID;
            }
          });
        }],
        watcher: {
          listener: function(field, newValue, oldValue, scope, stopWatching) {
            if(newValue) {
              var rules = (rulesOptions || []).find(function(rules){
                return rules.RuleGroupID == newValue;
              });
              if(rules) {
                var type = rules.RuleGroupType;
                if(type === '网站' || type === '广告') {
                  scope.options.formState.hideSiteId = false;
                } else {
                  scope.options.formState.hideSiteId = true;
                }
              }
            }
          }
        }
      },
      {
        key: 'SiteID',
        type: 'input2',
        hideExpression: 'formState.hideSiteId',
        templateOptions: {
          label: 'site ID/广告ID'
        },
        expressionProperties: {
          'templateOptions.required': '!formState.hideSiteId'
        }
      },
      {
        key: 'time',
        type: 'timeRange2',
        templateOptions: {
          label: '设置任务周期',
          required: true
        }
      }
    ];
  } else {
    tasksService.getTasks({HYUniqueid: $state.params.taskId})
    .then(function(data){
      console.log(data);
      if(data && data.Data && data.Data.length) {
        var _data = data.Data[0];
        $ctrl.data = _data;
        $ctrl.model = {
          RuleGroupID: _data.RuleGroupName,
          SiteID: _data.SiteID,
          time: {
            min: new Date(_data.StartDate),
            max: new Date(_data.EndDate)
          }
        };
        $ctrl.fields = [
          {
            key: 'RuleGroupID',
            type: 'static2',
            templateOptions: {
              label: '标签规则组'
            }
          }, 
          {
            key: 'SiteID',
            type: 'static2',
            hideExpression: '!model.SiteID',
            templateOptions: {
              label: 'site ID/广告ID'
            }
          },
          {
            key: 'time',
            type: 'timeRange2',
            templateOptions: {
              label: '设置任务周期',
              required: true
            }
          }
        ];
      }
    });
  }

  function createTask(){
    var data = {
      RuleGroupID: $ctrl.model.RuleGroupID,
      SiteID:      $ctrl.model.SiteID,
      StartTime:   $ctrl.model.time.min,
      EndTime:     $ctrl.model.time.max
    };
    console.log(data);
    tasksService.createTask(data).then(function(data){
      console.log(data);
    }, function(reason){
      console.log(reason);
    });
  }
}

module.exports = {
  template: require('./edit-task.component.html'),
  controller: controller
};
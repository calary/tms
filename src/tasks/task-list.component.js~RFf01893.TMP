require('./task-list.component.css');

controller.$inject = ['tasksService', 'rulesTypes', 'taskStatus'];
function controller(tasksService, rulesTypes, taskStatus){
  var $ctrl = this;
  $ctrl.list = [];
  $ctrl.filter = filter;

  // formly配置 
  $ctrl.model = {
    timeOption: 0
  };
  $ctrl.options = {};
  $ctrl.fields = [
    { 
      className: 'row',
      fieldGroup: [
        {
          key: 'siteid',
          type: 'input2',
          className: 'col-sm-6 col-md-3',
          templateOptions: {
            label: 'site ID/广告ID'
          }
        },
        {
          key: 'rulegroupname',
          type: 'input2',
          className: 'col-sm-6 col-md-3',
          templateOptions: {
            label: '规则组名称'
          }
        },
        {
          key: 'rulegrouptype',
          type: 'select2',
          className: 'col-sm-6 col-md-3',
          templateOptions: {
            label: '规则组类型',
            valueProp: 'id',
            labelProp: 'title',
            options: [{id: undefined, title: '全部'}].concat(rulesTypes)
          }
        },
        {
          key: 'status',
          type: 'select2',
          className: 'col-sm-6 col-md-3',
          templateOptions: {
            label: '任务状态',
            valueProp: 'id',
            labelProp: 'title',
            options: [{id: undefined, title: '全部'}].concat(taskStatus)
          }
        }
      ]
    },
    {
      className: 'row',
      fieldGroup: [
        {
          key: 'timeOption',
          type: 'select',
          className: 'col-sm-3',
          templateOptions: {
            label: '',
            valueProp: 'id',
            labelProp: 'title',
            options: [
              {id: 0, title: '开始时间'},
              {id: 1, title: '结束时间'},
            ]
          }
        },
        {
          key: 'time',
          type: 'timeRange',
          className: 'col-sm-9',
          templateOptions: {
            label: ''
          }
        }
      ]
    }
  ];

  // ui-table配置
  $ctrl.gridOptions = {
    data: '$ctrl.list',
    enableColumnMenus: false, // 隐藏列菜单
    enableSorting: false, // 禁止排序
    columnDefs: [
      { field: 'SiteID', displayName: 'site ID/广告ID'},
      { field: 'RuleGroupName', displayName: '规则组名称'},
      { field: 'RuleGroupType', displayName: '规则组类型'},
      { 
        field: 'StartDate', displayName: '开始时间', 
        cellFilter: 'date:"yyyy-MM-dd hh:mm:ss"'
      },
      { 
        field: 'EndDate', displayName: '结束时间', 
        cellFilter: 'date:"yyyy-MM-dd hh:mm:ss"'
      },
      { 
        field: 'Status', displayName: '状态',
        cellTemplate: 
          '<div class="ui-grid-cell-contents">' +
            '<div ng-switch="COL_FIELD">' +
              '<div ng-switch-when="0">未开始</div>' + 
              '<div ng-switch-when="1">执行中</div>' + 
              '<div ng-switch-when="2">暂停中</div>' + 
              '<div ng-switch-when="3">已结束</div>' + 
              '<div ng-switch-when="4">未加入</div>' + 
            '</div>' + 
          '</div>'
      },
      // { name: 'progress', displayName: '任务进度'},
      { 
        field: 'CreateTime', displayName: '创建时间',
        cellFilter: 'date:"yyyy-MM-dd hh:mm:ss"'
      }/*,
      { 
        name: 'control', 
        displayName: '操作',
        cellTemplate: 
          '<div class="ui-grid-cell-contents">' +
            '<a ui-href="editTask({taskId: \'\'})">编辑任务时间</a>' + 
          '</div>'
      }*/
    ]
  };

  filter();

  function filter(){
    var timeOption = $ctrl.model.timeOption;
    var time = $ctrl.model.time || {};
    var params = {
      siteid: $ctrl.model.siteid,
      rulegroupname: $ctrl.model.rulegroupname,
      rulegrouptype: $ctrl.model.rulegrouptype,
      status: $ctrl.model.status,
      startdate: timeOption == 0 && time.min || null,
      startdate1: timeOption == 0 && time.max || null,
      enddate: timeOption == 1 && time.min || null,
      enddate1: timeOption == 1 && time.max || null
    };

    tasksService.getTasks(params).then(function(data){
      $ctrl.list = data && data.Data || [];
    }, function(reason){
      console.log(reason);
    });
  }
}

module.exports = {
  template: require('./task-list.component.html'),
  controller: controller
};